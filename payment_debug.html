<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Debug Tool - Fuel@Door</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold mb-6 text-red-600">üîç Payment Page Debug Tool</h1>

        <div class="space-y-6">
            <!-- URL Parameters -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-3">üìç URL Parameters</h2>
                <div id="urlParams" class="font-mono text-sm"></div>
            </div>

            <!-- LocalStorage Data -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-3">üíæ LocalStorage Data</h2>
                <div id="localStorageData" class="font-mono text-sm"></div>
            </div>

            <!-- Parsed Values -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-3">‚úÖ Parsed Values</h2>
                <div id="parsedValues" class="font-mono text-sm"></div>
            </div>

            <!-- Issues Found -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-3">‚ùå Issues Found</h2>
                <div id="issues" class="font-mono text-sm"></div>
            </div>

            <!-- Recommendations -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-3">üí° Recommendations</h2>
                <div id="recommendations" class="font-mono text-sm"></div>
            </div>
        </div>

        <div class="mt-8 flex gap-4">
            <button onclick="window.location.href='qr_payment_section.html'"
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Go to Payment Page
            </button>
            <button onclick="window.location.href='order-summary.html'"
                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Go to Order Summary
            </button>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const urlOrderId = urlParams.get('orderId');
        const urlAmount = urlParams.get('amount');

        // Get localStorage data
        const pendingOrderStr = localStorage.getItem('pendingOrder');
        const fuelOrderStr = localStorage.getItem('fuelAtDoorOrder');
        const userDataStr = localStorage.getItem('fuelAtDoorUser');

        let pendingOrder = null;
        let fuelOrder = null;
        let userData = null;

        try {
            pendingOrder = pendingOrderStr ? JSON.parse(pendingOrderStr) : null;
        } catch (e) {
            console.error('Error parsing pendingOrder:', e);
        }

        try {
            fuelOrder = fuelOrderStr ? JSON.parse(fuelOrderStr) : null;
        } catch (e) {
            console.error('Error parsing fuelAtDoorOrder:', e);
        }

        try {
            userData = userDataStr ? JSON.parse(userDataStr) : null;
        } catch (e) {
            console.error('Error parsing fuelAtDoorUser:', e);
        }

        // Display URL Parameters
        document.getElementById('urlParams').innerHTML = `
            <div class="space-y-2">
                <div><strong>Full URL:</strong> ${window.location.href}</div>
                <div><strong>Query String:</strong> ${window.location.search || '(empty)'}</div>
                <div><strong>orderId:</strong> ${urlOrderId || '‚ùå NOT FOUND'}</div>
                <div><strong>amount:</strong> ${urlAmount || '‚ùå NOT FOUND'}</div>
            </div>
        `;

        // Display LocalStorage Data
        document.getElementById('localStorageData').innerHTML = `
            <div class="space-y-4">
                <div>
                    <strong>pendingOrder:</strong>
                    <pre class="bg-white p-2 rounded mt-1 overflow-auto">${pendingOrderStr || '‚ùå NOT FOUND'}</pre>
                </div>
                <div>
                    <strong>fuelAtDoorOrder:</strong>
                    <pre class="bg-white p-2 rounded mt-1 overflow-auto">${fuelOrderStr || '‚ùå NOT FOUND'}</pre>
                </div>
                <div>
                    <strong>fuelAtDoorUser:</strong>
                    <pre class="bg-white p-2 rounded mt-1 overflow-auto">${userDataStr || '‚ùå NOT FOUND'}</pre>
                </div>
            </div>
        `;

        // Parse and display values
        let finalOrderId = null;
        let finalAmount = null;

        if (urlOrderId && urlAmount) {
            finalOrderId = urlOrderId;
            finalAmount = parseFloat(urlAmount);
        } else if (pendingOrder) {
            finalOrderId = pendingOrder.orderId;
            finalAmount = pendingOrder.totalAmount;
        }

        document.getElementById('parsedValues').innerHTML = `
            <div class="space-y-2">
                <div><strong>Final Order ID:</strong> ${finalOrderId || '‚ùå MISSING'}</div>
                <div><strong>Final Amount:</strong> ${finalAmount ? `‚Çπ${finalAmount}` : '‚ùå MISSING or NaN'}</div>
                <div><strong>Amount is Number:</strong> ${typeof finalAmount === 'number' && !isNaN(finalAmount) ? '‚úÖ Yes' : '‚ùå No'}</div>
            </div>
        `;

        // Identify issues
        const issues = [];
        const recommendations = [];

        if (!urlOrderId && !pendingOrder?.orderId) {
            issues.push('‚ùå No Order ID found in URL or localStorage');
            recommendations.push('Check summary.js line 252 - ensure redirect includes orderId parameter');
            recommendations.push('Check summary.js line 234 - ensure Order ID is generated correctly');
        }

        if (!urlAmount && !pendingOrder?.totalAmount) {
            issues.push('‚ùå No amount found in URL or localStorage');
            recommendations.push('Check summary.js line 252 - ensure redirect includes amount parameter');
            recommendations.push('Check summary.js line 239 - ensure totalAmount is stored in pendingOrder');
        }

        if (finalAmount && isNaN(finalAmount)) {
            issues.push('‚ùå Amount is NaN (Not a Number)');
            recommendations.push('Check that total is calculated correctly in summary.js');
            recommendations.push('Verify calculateOrder() returns a valid number');
        }

        if (!pendingOrderStr) {
            issues.push('‚ö†Ô∏è pendingOrder not found in localStorage');
            recommendations.push('This is set in summary.js line 246 - check if order creation succeeded');
        }

        if (urlParams.toString() === '' && !pendingOrderStr) {
            issues.push('üö® CRITICAL: No data source available (neither URL params nor localStorage)');
            recommendations.push('Order creation likely failed - check browser console for errors');
            recommendations.push('Check if RLS policies are blocking order insertion');
        }

        // Display issues
        if (issues.length === 0) {
            document.getElementById('issues').innerHTML = '<div class="text-green-600">‚úÖ No issues detected! Data looks good.</div>';
        } else {
            document.getElementById('issues').innerHTML = issues.map(issue => `<div class="mb-2">${issue}</div>`).join('');
        }

        // Display recommendations
        if (recommendations.length === 0) {
            document.getElementById('recommendations').innerHTML = '<div class="text-green-600">‚úÖ Everything looks correct!</div>';
        } else {
            document.getElementById('recommendations').innerHTML = `
                <ol class="list-decimal list-inside space-y-2">
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ol>
            `;
        }

        // Console output for easy copying
        console.log('=== PAYMENT DEBUG REPORT ===');
        console.log('URL Order ID:', urlOrderId);
        console.log('URL Amount:', urlAmount);
        console.log('localStorage pendingOrder:', pendingOrder);
        console.log('Final Order ID:', finalOrderId);
        console.log('Final Amount:', finalAmount);
        console.log('Issues:', issues);
        console.log('Recommendations:', recommendations);
    </script>
</body>

</html>
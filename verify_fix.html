<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Order Fix - Fuel@Door</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-6xl">
        <h1 class="text-3xl font-bold mb-6">Verify Order Placement Fix</h1>
        
        <!-- Database Schema Check -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Database Schema Verification</h2>
            <button id="checkSchema" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Check Orders Table Schema
            </button>
            <div id="schemaResult" class="mt-4"></div>
        </div>

        <!-- Clear Browser Cache -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Clear Browser Cache</h2>
            <button id="clearCache" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                Clear Cache & Reload
            </button>
            <p class="text-sm text-gray-600 mt-2">This will clear localStorage and reload the page with cache bypass</p>
        </div>

        <!-- Test Order Placement -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Order Placement</h2>
            <form id="testOrderForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Customer Name:</label>
                        <input type="text" id="customerName" value="Test Customer" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Customer Mobile:</label>
                        <input type="text" id="customerMobile" value="9999999999" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fuel Type:</label>
                        <select id="fuelType" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="petrol">Petrol</option>
                            <option value="diesel">Diesel</option>
                            <option value="ev">EV</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Quantity:</label>
                        <input type="number" id="quantity" value="15" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        <p class="text-xs text-gray-500 mt-1">Testing with 15L to verify variable delivery fee (should be ‚Çπ75)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price per Liter:</label>
                        <input type="number" id="pricePerLiter" value="105" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Select Pump:</label>
                        <select id="pumpSelect" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Address:</label>
                    <textarea id="address" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">123 Test Street, Test City, Test State</textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pincode:</label>
                        <input type="text" id="pincode" value="400001" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Delivery Time:</label>
                        <select id="deliveryTime" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="morning">Morning (8:00 AM - 12:00 PM)</option>
                            <option value="afternoon">Afternoon (12:00 PM - 4:00 PM)</option>
                            <option value="evening">Evening (4:00 PM - 8:00 PM)</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="bg-red-500 text-white px-6 py-3 rounded hover:bg-red-600 text-lg">
                    Test Order Placement
                </button>
            </form>
            <div id="orderResult" class="mt-4"></div>
        </div>

        <!-- Payload Preview -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Order Payload Preview</h2>
            <pre id="payloadPreview" class="bg-gray-100 p-4 rounded text-sm overflow-x-auto h-96"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
    <script src="config.js"></script>
    <script>
        // Initialize Supabase
        let supabaseClient = null;
        try {
            if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY && window.supabase) {
                supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
            }
        } catch (err) {
            console.warn("Supabase init failed:", err);
        }

        const ORDERS_TABLE = 'orders';
        const PETROL_PUMPS_TABLE = 'petrol_pumps';
        
        // Variable delivery fee calculation
        const BASE_DELIVERY_FEE = 50;
        const EXTRA_DELIVERY_FEE_PER_LITER = 5;
        
        function calculateDeliveryFee(quantity) {
            if (quantity <= 10) {
                return BASE_DELIVERY_FEE;
            }
            const extraLiters = quantity - 10;
            return BASE_DELIVERY_FEE + (extraLiters * EXTRA_DELIVERY_FEE_PER_LITER);
        }

        // Check database schema
        document.getElementById('checkSchema').addEventListener('click', async () => {
            const resultDiv = document.getElementById('schemaResult');
            resultDiv.innerHTML = '<div class="text-blue-600">Checking schema...</div>';

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }

                // Query the database schema using a simple method
                const { data, error } = await supabaseClient
                    .from(ORDERS_TABLE)
                    .select('*')
                    .limit(1);

                if (error) {
                    throw error;
                }

                // Try to insert a minimal test record to see which fields are required/allowed
                const testPayload = {
                    customer_name: 'Schema Test',
                    customer_mobile: '0000000000',
                    fuel_type: 'petrol',
                    quantity: 10,
                    unit: 'liters',
                    price_per_liter: 105,
                    customer_location: 'Test Location',
                    assigned_pump_id: 1,
                    fuel_cost: 1050,
                    delivery_fee: 50,
                    total_amount: 1100,
                    status: 'pending'
                };

                // This is just to test the schema - we'll delete this record if it succeeds
                const { data: testData, error: testError } = await supabaseClient
                    .from(ORDERS_TABLE)
                    .insert([testPayload])
                    .select('id')
                    .single();

                if (testError) {
                    resultDiv.innerHTML = `
                        <div class="text-red-600">
                            <strong>Schema Test Failed:</strong><br>
                            <strong>Error:</strong> ${testError.message}<br>
                            <strong>Code:</strong> ${testError.code || 'N/A'}<br>
                            <strong>Details:</strong> ${testError.details || 'N/A'}<br>
                            <strong>Hint:</strong> ${testError.hint || 'N/A'}
                        </div>
                    `;
                    return;
                }

                // Clean up the test record
                if (testData && testData.id) {
                    await supabaseClient
                        .from(ORDERS_TABLE)
                        .delete()
                        .eq('id', testData.id);
                }

                resultDiv.innerHTML = `
                    <div class="text-green-600">
                        ‚úì Schema test passed! All required columns exist.<br>
                        Test record ID ${testData.id} was created and deleted successfully.
                    </div>
                `;

            } catch (error) {
                console.error('Schema check error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        ‚úó Schema check failed:<br>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        });

        // Clear cache and reload
        document.getElementById('clearCache').addEventListener('click', () => {
            // Clear all localStorage
            localStorage.clear();
            
            // Clear sessionStorage
            sessionStorage.clear();
            
            // Reload page with cache bypass
            window.location.reload(true);
        });

        // Load petrol pumps
        async function loadPumps() {
            const pumpSelect = document.getElementById('pumpSelect');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }

                const { data: pumps, error } = await supabaseClient
                    .from(PETROL_PUMPS_TABLE)
                    .select('id, company_name, location, fuel_price, status')
                    .eq('status', 'active')
                    .order('company_name');

                if (error) {
                    throw error;
                }

                pumpSelect.innerHTML = '<option value="">Select a petrol pump</option>';
                pumps.forEach(pump => {
                    const option = document.createElement('option');
                    option.value = pump.id;
                    option.textContent = `${pump.company_name} - ${pump.location} (‚Çπ${pump.fuel_price}/L)`;
                    pumpSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading pumps:', error);
                pumpSelect.innerHTML = '<option value="">Error loading pumps</option>';
            }
        }

        // Update payload preview
        function updatePayloadPreview() {
            const customerName = document.getElementById('customerName').value;
            const customerMobile = document.getElementById('customerMobile').value;
            const fuelType = document.getElementById('fuelType').value;
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const pricePerLiter = parseFloat(document.getElementById('pricePerLiter').value) || 0;
            const address = document.getElementById('address').value;
            const pincode = document.getElementById('pincode').value;
            const pumpId = document.getElementById('pumpSelect').value;
            const deliveryTime = document.getElementById('deliveryTime').value;

            const fuelCost = pricePerLiter * quantity;
            const deliveryFee = calculateDeliveryFee(quantity);
            const tax = (fuelCost + deliveryFee) * 0.05;
            const total = fuelCost + deliveryFee + tax;

            const payload = {
                customer_name: customerName,
                customer_mobile: customerMobile,
                fuel_type: fuelType,
                quantity: quantity,
                unit: 'liters',
                price_per_liter: pricePerLiter,
                customer_location: address,
                landmark: null,
                pincode: pincode,
                delivery_time: deliveryTime,
                assigned_pump_id: pumpId ? parseInt(pumpId) : null,
                fuel_cost: fuelCost,
                delivery_fee: deliveryFee,
                total_amount: total,
                status: 'pending',
                created_at: new Date().toISOString()
            };

            // Highlight the important changes
            const preview = `ORDER PAYLOAD (No customer_latitude/longitude):
${JSON.stringify(payload, null, 2)}

DELIVERY FEE CALCULATION:
- Quantity: ${quantity}L
- Base fee (‚â§10L): ‚Çπ${BASE_DELIVERY_FEE}
- Extra liters: ${Math.max(0, quantity - 10)}L
- Extra fee: ‚Çπ${Math.max(0, quantity - 10) * EXTRA_DELIVERY_FEE_PER_LITER}
- Total delivery fee: ‚Çπ${deliveryFee}

TOTAL BREAKDOWN:
- Fuel cost: ‚Çπ${fuelCost.toFixed(2)}
- Delivery fee: ‚Çπ${deliveryFee.toFixed(2)}
- Tax (5%): ‚Çπ${tax.toFixed(2)}
- Grand total: ‚Çπ${total.toFixed(2)}`;

            document.getElementById('payloadPreview').textContent = preview;
        }

        // Form change listeners
        ['customerName', 'customerMobile', 'fuelType', 'quantity', 'pricePerLiter', 'address', 'pincode', 'pumpSelect', 'deliveryTime'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePayloadPreview);
            document.getElementById(id).addEventListener('change', updatePayloadPreview);
        });

        // Test order placement
        document.getElementById('testOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const resultDiv = document.getElementById('orderResult');
            resultDiv.innerHTML = '<div class="text-blue-600 text-lg">üß™ Testing order placement...</div>';

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }

                const customerName = document.getElementById('customerName').value;
                const customerMobile = document.getElementById('customerMobile').value;
                const fuelType = document.getElementById('fuelType').value;
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const pricePerLiter = parseFloat(document.getElementById('pricePerLiter').value) || 0;
                const address = document.getElementById('address').value;
                const pincode = document.getElementById('pincode').value;
                const pumpId = document.getElementById('pumpSelect').value;
                const deliveryTime = document.getElementById('deliveryTime').value;

                if (!pumpId) {
                    throw new Error('Please select a petrol pump');
                }

                const fuelCost = pricePerLiter * quantity;
                const deliveryFee = calculateDeliveryFee(quantity);
                const tax = (fuelCost + deliveryFee) * 0.05;
                const total = fuelCost + deliveryFee + tax;

                const orderPayload = {
                    customer_name: customerName,
                    customer_mobile: customerMobile,
                    fuel_type: fuelType,
                    quantity: quantity,
                    unit: 'liters',
                    price_per_liter: pricePerLiter,
                    customer_location: address,
                    landmark: null,
                    pincode: pincode,
                    delivery_time: deliveryTime,
                    assigned_pump_id: parseInt(pumpId),
                    fuel_cost: fuelCost,
                    delivery_fee: deliveryFee,
                    total_amount: total,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };

                console.log('Placing order with payload:', orderPayload);

                const { data, error } = await supabaseClient
                    .from(ORDERS_TABLE)
                    .insert([orderPayload])
                    .select('id')
                    .single();

                if (error) {
                    throw error;
                }

                resultDiv.innerHTML = `
                    <div class="text-green-600 text-lg">
                        ‚úÖ <strong>Order placed successfully!</strong><br><br>
                        üìã <strong>Order ID:</strong> ${data.id}<br>
                        üí∞ <strong>Total:</strong> ‚Çπ${total.toFixed(2)}<br>
                        üöö <strong>Delivery Fee:</strong> ‚Çπ${deliveryFee} (for ${quantity}L)<br>
                        üìç <strong>Pump ID:</strong> ${pumpId}<br><br>
                        <span class="text-sm">‚úÖ No customer_latitude error - fix successful!</span>
                    </div>
                `;

            } catch (error) {
                console.error('Order placement error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600 text-lg">
                        ‚ùå <strong>Order placement failed:</strong><br><br>
                        üö® <strong>Error:</strong> ${error.message}<br>
                        üîß <strong>Code:</strong> ${error.code || 'N/A'}<br>
                        üìã <strong>Details:</strong> ${error.details || 'N/A'}<br>
                        üí° <strong>Hint:</strong> ${error.hint || 'N/A'}
                    </div>
                `;
            }
        });

        // Initialize
        updatePayloadPreview();
        loadPumps();
    </script>
</body>
</html>
